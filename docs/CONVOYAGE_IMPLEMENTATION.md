# üöó Impl√©mentation Convoyage de V√©hicules - Documentation Technique

**Date de d√©but** : 2025-10-06
**Statut** : En cours (60% compl√©t√©)
**Estimation restante** : 2-3h

---

## üìã Vue d'ensemble

Ajout d'une nouvelle prestation "Convoyage de V√©hicules" permettant le transport d'un v√©hicule du point A au point B avec :
- ‚úÖ Lettre de voiture conforme CMR 2025
- ‚úÖ Inspection photographique compl√®te (12 positions avant/apr√®s)
- ‚úÖ Signatures √©lectroniques (d√©part et arriv√©e)
- ‚úÖ Tra√ßabilit√© GPS compl√®te

---

## ‚úÖ Travaux Compl√©t√©s (60%)

### 1. Base de donn√©es ‚úÖ

**Migration** : `add_convoyage_feature_v2`

```sql
-- Nouveau type d'intervention
INSERT INTO intervention_types (name, code, description, is_active)
VALUES ('Convoyage V√©hicule', 'CONVOYAGE', 'Transport d''un v√©hicule...', true);

-- Nouvelle table pour lettres de voiture
CREATE TABLE vehicle_handover_docs (
  id UUID PRIMARY KEY,
  intervention_id UUID REFERENCES interventions(id),
  doc_type TEXT CHECK (doc_type IN ('lettre_voiture_depart', 'lettre_voiture_arrivee')),

  -- Donneur d'ordre
  donneur_ordre_nom TEXT NOT NULL,
  donneur_ordre_adresse TEXT NOT NULL,
  donneur_ordre_contact TEXT,

  -- V√©hicule
  vehicle_id UUID REFERENCES vehicles(id),
  immatriculation TEXT NOT NULL,
  vin TEXT,
  marque TEXT NOT NULL,
  modele TEXT NOT NULL,
  couleur TEXT,
  kilometrage INTEGER,

  -- Trajet
  adresse_depart TEXT NOT NULL,
  adresse_arrivee TEXT NOT NULL,
  date_prise_charge TIMESTAMPTZ,
  date_remise TIMESTAMPTZ,

  -- Signatures (base64)
  signature_agent_base64 TEXT,
  signature_client_base64 TEXT,
  signature_date TIMESTAMPTZ,

  -- Observations
  observations_depart TEXT,
  observations_arrivee TEXT,
  etat_carburant TEXT,

  -- PDF g√©n√©r√©
  pdf_url TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index + RLS policies cr√©√©s
```

**Status** : ‚úÖ Appliqu√© avec succ√®s

---

### 2. Librairies install√©es ‚úÖ

```bash
pnpm add signature_pad @types/signature_pad
```

**Status** : ‚úÖ Install√© (signature_pad v5.1.1)

---

### 3. TypeScript Types ‚úÖ

**Fichier** : `src/types/intervention.ts`

```typescript
export interface ConvoyageFormData {
  type: 'convoyage';
  vehicleId: string | null;
  clientId: string | null;
  notes?: string;

  // Step 1: Donneur d'ordre
  donneurOrdreNom?: string;
  donneurOrdreAdresse?: string;
  donneurOrdreContact?: string;
  adresseDepart?: string;
  adresseArrivee?: string;
  observations?: string;

  // Step 2: Vehicle info
  immatriculation?: string;
  vin?: string;
  marque?: string;
  modele?: string;
  couleur?: string;
  kilometrage?: number;
  etatCarburant?: string;

  // Step 3: Photos prise en charge (12 positions)
  photosPriseEnCharge?: File[];

  // Step 4: Lettre de voiture d√©part
  signatureAgentDepart?: string; // base64
  signatureClientDepart?: string; // base64
  observationsDepart?: string;

  // Step 5: Photos remise + lettre arriv√©e
  photosRemise?: File[];
  signatureAgentArrivee?: string; // base64
  signatureClientArrivee?: string; // base64
  observationsArrivee?: string;
}

export type InterventionFormData =
  | LavageFormData
  | CarburantLivraisonFormData
  | CarburantCuveFormData
  | ConvoyageFormData; // ‚úÖ Ajout√©
```

**Status** : ‚úÖ Types cr√©√©s et int√©gr√©s

---

### 4. Composants Mobile Cr√©√©s ‚úÖ

#### Step 1 - Donneur d'ordre ‚úÖ
**Fichier** : `src/components/interventions/convoyage/Step1DonneurOrdre.tsx`

**Champs** :
- ‚úÖ Nom/Raison sociale du donneur d'ordre (requis)
- ‚úÖ Adresse compl√®te (requis)
- ‚úÖ Contact (t√©l√©phone/email)
- ‚úÖ Adresse point A - d√©part (requis)
- ‚úÖ Adresse point B - arriv√©e (requis)
- ‚úÖ Observations/instructions particuli√®res

**Status** : ‚úÖ Cr√©√© et fonctionnel

---

#### Step 2 - Infos v√©hicule ‚úÖ
**Fichier** : `src/components/interventions/convoyage/Step2VehiculeInfos.tsx`

**Champs** :
- ‚úÖ Immatriculation (requis, formatage auto uppercase)
- ‚úÖ VIN - 17 caract√®res (optionnel mais recommand√©, validation longueur)
- ‚úÖ Marque (requis)
- ‚úÖ Mod√®le (requis)
- ‚úÖ Couleur
- ‚úÖ Kilom√©trage (num√©rique)
- ‚úÖ Niveau carburant (select : Vide/R√©serve/Faible/Moyen/Plein)

**Status** : ‚úÖ Cr√©√© et fonctionnel

---

## üöß Travaux Restants (40%)

### 5. Step 3 - Photos Prise en Charge üì∏

**Fichier √† cr√©er** : `src/components/interventions/convoyage/Step3PhotosPriseEnCharge.tsx`

**Sp√©cifications** :
- **12 positions obligatoires** avec guidage visuel :
  1. Capot (face avant)
  2. Aile avant gauche
  3. Porte avant gauche
  4. Porte arri√®re gauche
  5. Aile arri√®re gauche
  6. Coffre (face arri√®re)
  7. Aile arri√®re droite
  8. Porte arri√®re droite
  9. Porte avant droite
  10. Aile avant droite
  11. Toit (vue panoramique)
  12. Tableau de bord (compteur kilom√©trique)

**Fonctionnalit√©s** :
- [ ] Overlay sch√©ma voiture montrant position √† photographier
- [ ] Compteur progression (X/12)
- [ ] Validation qu'au moins 1 photo par position
- [ ] Compression automatique (max 1MB/photo)
- [ ] Preview avant validation
- [ ] Possibilit√© de retirer/remplacer photos

**Composant technique** :
```tsx
interface PhotoPosition {
  id: string;
  label: string;
  icon: JSX.Element; // Ic√¥ne visuelle
  description: string;
  required: boolean;
}

const PHOTO_POSITIONS: PhotoPosition[] = [
  { id: 'capot', label: 'Capot', icon: <CarFrontIcon />, description: 'Vue face avant compl√®te', required: true },
  // ... 11 autres positions
];
```

**Status** : ‚è≥ √Ä cr√©er

---

### 6. Step 4 - Lettre de Voiture D√©part + Signatures üìù

**Fichier √† cr√©er** : `src/components/interventions/convoyage/Step4LettreVoitureDepart.tsx`

**Sp√©cifications** :
- [ ] Affichage r√©sum√© r√©capitulatif (toutes infos saisies)
- [ ] Section "Observations au d√©part" (textarea)
- [ ] Pad signature AGENT (canvas avec signature_pad)
- [ ] Bouton "Demander signature client"
- [ ] Pad signature CLIENT (canvas)
- [ ] Validation : signatures obligatoires
- [ ] G√©n√©ration aper√ßu lettre de voiture (HTML preview)

**Int√©gration signature_pad** :
```tsx
import SignaturePad from 'signature_pad';

const signaturePadRef = useRef<SignaturePad | null>(null);
const canvasRef = useRef<HTMLCanvasElement>(null);

useEffect(() => {
  if (canvasRef.current) {
    signaturePadRef.current = new SignaturePad(canvasRef.current, {
      backgroundColor: 'rgb(255, 255, 255)',
      penColor: 'rgb(0, 0, 0)'
    });
  }
}, []);

const getSignatureBase64 = () => {
  return signaturePadRef.current?.toDataURL('image/png');
};
```

**Status** : ‚è≥ √Ä cr√©er

---

### 7. Step 5 - Photos Remise + Lettre Arriv√©e üì∏üìù

**Fichier √† cr√©er** : `src/components/interventions/convoyage/Step5PhotosRemise.tsx`

**Sp√©cifications** :
- [ ] **M√™me 12 positions** que Step 3 (r√©utiliser logique)
- [ ] Vue comparative c√¥te √† c√¥te (photo d√©part vs arriv√©e)
- [ ] Section "Observations √† l'arriv√©e"
- [ ] Pad signature AGENT arriv√©e
- [ ] Pad signature CLIENT destinataire arriv√©e
- [ ] Validation finale avant soumission

**Status** : ‚è≥ √Ä cr√©er

---

### 8. Orchestrateur ConvoyageSteps üéØ

**Fichier √† cr√©er** : `src/components/interventions/ConvoyageSteps.tsx`

**Sp√©cifications** :
```tsx
interface ConvoyageStepsProps {
  currentStep: number; // 1 √† 5
  formData: Partial<ConvoyageFormData>;
  onNext: (data: Partial<ConvoyageFormData>) => void;
  onPrevious: () => void;
  onSubmit: (data: Partial<ConvoyageFormData>) => void;
  isSubmitting: boolean;
}

export default function ConvoyageSteps({...}) {
  return (
    <>
      {currentStep === 1 && <Step1DonneurOrdre {...} />}
      {currentStep === 2 && <Step2VehiculeInfos {...} />}
      {currentStep === 3 && <Step3PhotosPriseEnCharge {...} />}
      {currentStep === 4 && <Step4LettreVoitureDepart {...} />}
      {currentStep === 5 && <Step5PhotosRemise {...} />}
    </>
  );
}
```

**Status** : ‚è≥ √Ä cr√©er

---

### 9. Int√©gration Page Principale üîó

**Fichier √† modifier** : `src/components/interventions/Step1TypePrestation.tsx`

**Ajout dans l'array `types`** :
```tsx
{
  id: 'convoyage',
  label: 'Convoyage',
  icon: (
    <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
    </svg>
  ),
  description: 'Transport de v√©hicule du point A au point B'
}
```

**Status** : ‚è≥ √Ä faire

---

**Fichier √† modifier** : `src/app/nouvelle-intervention/page.tsx`

**Ajout du switch case** :
```tsx
{typePrestation === 'convoyage' && currentStep > 1 && (
  <ConvoyageSteps
    currentStep={currentStep - 1}
    formData={formData}
    onNext={handleNext}
    onPrevious={handlePrevious}
    onSubmit={handleSubmit}
    isSubmitting={isSubmitting}
  />
)}
```

**Ajout des steps** :
```tsx
if (typePrestation === 'convoyage') {
  return [
    { number: 1, label: 'Type de prestation', completed: true },
    { number: 2, label: 'Donneur d\'ordre', completed: currentStep > 2 },
    { number: 3, label: 'V√©hicule', completed: currentStep > 3 },
    { number: 4, label: 'Photos prise en charge', completed: currentStep > 4 },
    { number: 5, label: 'Lettre d√©part', completed: currentStep > 5 },
    { number: 6, label: 'Photos remise', completed: false },
  ];
}
```

**Status** : ‚è≥ √Ä faire

---

### 10. Backend API üîß

**Fichier √† modifier** : `src/app/api/interventions/route.ts`

**Modifications n√©cessaires** :

#### a) Mapping type d'intervention
```tsx
// Ligne ~272
type: typePrestation === 'lavage' ? 'Lavage V√©hicule' :
      typePrestation === 'carburant-livraison' ? 'Livraison Carburant' :
      typePrestation === 'carburant-cuve' ? 'Remplissage Cuve' :
      typePrestation === 'convoyage' ? 'Convoyage V√©hicule' : // ‚úÖ Ajouter
      null,
```

#### b) Upload photos prise en charge
```tsx
// Apr√®s ligne ~307
const photosPriseEnChargeFiles = formData.getAll('photosPriseEnCharge') as File[];
const photosRemiseFiles = formData.getAll('photosRemise') as File[];

// ... upload logic similar to existing photos
```

#### c) Sauvegarder signatures + metadata convoyage
```tsx
// Dans metadata update (apr√®s ligne ~500)
const photoMetadata = {
  // ... existing photos
  photosPriseEnCharge: photosPriseEnChargeUrls.map((url, idx) => ({...})),
  photosRemise: photosRemiseUrls.map((url, idx) => ({...})),
};

// Ajouter donn√©es convoyage dans metadata
metadata: {
  ...metadata,
  photos: photoMetadata,
  convoyage: {
    donneurOrdreNom: formData.get('donneurOrdreNom'),
    immatriculation: formData.get('immatriculation'),
    vin: formData.get('vin'),
    adresseDepart: formData.get('adresseDepart'),
    adresseArrivee: formData.get('adresseArrivee'),
    signatureAgentDepart: formData.get('signatureAgentDepart'),
    signatureClientDepart: formData.get('signatureClientDepart'),
    signatureAgentArrivee: formData.get('signatureAgentArrivee'),
    signatureClientArrivee: formData.get('signatureClientArrivee'),
  }
}
```

**Status** : ‚è≥ √Ä faire

---

### 11. G√©n√©ration PDF Lettre de Voiture (Phase 2 - Optionnel)

**Fichier √† cr√©er** : `src/app/api/convoyage/lettre-voiture/route.ts`

**Sp√©cifications** :
- [ ] Endpoint POST acceptant intervention_id
- [ ] R√©cup√©ration donn√©es depuis vehicle_handover_docs + interventions
- [ ] G√©n√©ration PDF avec template professionnel
- [ ] Upload PDF vers Supabase Storage
- [ ] Retour URL publique

**Librairie recommand√©e** : `@react-pdf/renderer` ou `jsPDF`

**Template PDF** :
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LETTRE DE VOITURE - CONVOYAGE         ‚îÇ
‚îÇ  N¬∞ [ID]                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  DONNEUR D'ORDRE                        ‚îÇ
‚îÇ  [NOM] - [ADRESSE] - [CONTACT]         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  V√âHICULE                               ‚îÇ
‚îÇ  [IMMAT] - VIN: [VIN]                   ‚îÇ
‚îÇ  [MARQUE] [MODELE] - [COULEUR]         ‚îÇ
‚îÇ  Kilom√©trage: [KM] km                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  TRAJET                                 ‚îÇ
‚îÇ  D√©part: [ADRESSE] - [DATE]            ‚îÇ
‚îÇ  Arriv√©e: [ADRESSE] - [DATE]           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  SIGNATURES                             ‚îÇ
‚îÇ  Agent: [IMG]    Client: [IMG]          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Status** : ‚è≥ Phase 2 (pas bloquant pour MVP)

---

### 12. Portail Admin - Vue Convoyage (Phase 2)

**Fichiers √† modifier/cr√©er** :
- `src/app/(admin)/admin/interventions/page.tsx` - Badge sp√©cial convoyage
- `src/components/admin/InterventionDetailModal.tsx` - Onglet "Lettre de voiture"
- Nouvelle vue : Galerie photos comparatif (avant/apr√®s)

**Fonctionnalit√©s** :
- [ ] Badge "üöó Convoyage" dans tableau interventions
- [ ] Colonnes sp√©cifiques : Point A ‚Üí Point B
- [ ] Modal d√©tails avec onglets :
  - Infos g√©n√©rales
  - Lettre de voiture (PDF t√©l√©chargeable)
  - Photos prise en charge (12 miniatures)
  - Photos remise (12 miniatures)
  - Vue comparative slider

**Status** : ‚è≥ Phase 2 (pas bloquant pour MVP)

---

## üìê Architecture Technique

### Cadencement Photos (12 Positions Standard)

Bas√© sur les meilleures pratiques CapCar et inspections professionnelles :

```
        [1. Capot]
           |
    [2]---+---[10]    2 = Aile AV gauche
     |    |    |      10 = Aile AV droite
    [3]   |   [9]     3 = Porte AV gauche
     |    |    |      9 = Porte AV droite
    [4]   |   [8]     4 = Porte AR gauche
     |    |    |      8 = Porte AR droite
    [5]---+---[7]     5 = Aile AR gauche
           |          7 = Aile AR droite
       [6. Coffre]

    [11. Toit vue panoramique]
    [12. Tableau de bord (compteur)]
```

**Pourquoi 12 positions ?**
- ‚úÖ Couverture compl√®te 360¬∞ du v√©hicule
- ‚úÖ Standard professionnel inspection automobile
- ‚úÖ Protection juridique en cas de litige
- ‚úÖ Tra√ßabilit√© optimale √©tat v√©hicule

---

## üéØ Plan d'Ex√©cution Restant

### Ordre recommand√© :

1. **Step3PhotosPriseEnCharge.tsx** (2h)
   - Composant guidage visuel
   - Gestion upload 12 photos
   - Preview et validation

2. **Step4LettreVoitureDepart.tsx** (1h)
   - R√©sum√© r√©capitulatif
   - Int√©gration SignaturePad
   - Validation signatures

3. **Step5PhotosRemise.tsx** (1h)
   - R√©utilisation logique Step 3
   - Vue comparative
   - Signatures arriv√©e

4. **ConvoyageSteps.tsx** (30min)
   - Orchestrateur simple
   - Switch entre steps

5. **Int√©gration page principale** (30min)
   - Ajout dans Step1TypePrestation
   - Switch case dans nouvelle-intervention

6. **Modification API** (1h)
   - Upload photos suppl√©mentaires
   - Sauvegarder metadata convoyage

7. **Tests E2E** (1h)
   - Flux complet mobile
   - Validation donn√©es
   - Upload photos

**Total estim√©** : ~7h pour version compl√®te fonctionnelle

---

## üîç Points d'Attention

### S√©curit√©
- ‚úÖ RLS policies cr√©√©es sur vehicle_handover_docs
- ‚ö†Ô∏è Signatures stock√©es en base64 (consid√©rer chiffrement futur)
- ‚ö†Ô∏è Photos lourdes : compression obligatoire (max 1MB)

### Performance
- ‚ö†Ô∏è 24 photos au total (12 d√©part + 12 arriv√©e) = potentiel ~24MB
- ‚úÖ Compression automatique imp√©rative
- ‚úÖ Upload progressif avec feedback utilisateur

### UX Mobile
- ‚ö†Ô∏è Mode paysage recommand√© pour photos v√©hicule
- ‚ö†Ô∏è Haptic feedback √† chaque validation
- ‚ö†Ô∏è Guidance visuelle claire (overlay sch√©ma)

### RGPD
- ‚ö†Ô∏è Signatures = donn√©es personnelles
- ‚ö†Ô∏è Photos peuvent contenir plaques immatriculation
- ‚úÖ RLS emp√™che acc√®s non autoris√©

---

## üìö Ressources & R√©f√©rences

### Documentation consult√©e :
- [Lettre de voiture CMR 2025](https://www.dashdoc.com/fr/blog/lettre-de-voiture)
- [Inspection v√©hicule CapCar](https://www.capcar.fr/comment-ca-marche/la-certification-dinspection)
- [SafetyCulture Vehicle Handover Checklist](https://safetyculture.com/checklists/vehicle-inspection)

### Code des transports :
- Article R3411-13 : Lettre de voiture obligatoire
- Amende 5e classe si absent lors contr√¥le

---

## üöÄ Commande pour Continuer

Pour reprendre le d√©veloppement :
```bash
# Lire cette documentation
cat docs/CONVOYAGE_IMPLEMENTATION.md

# Cr√©er Step 3
# ... voir section "Plan d'Ex√©cution Restant"
```

---

**Derni√®re mise √† jour** : 2025-10-06 18:00
**Auteur** : Claude Code
**Version** : 1.0
